{"version":3,"sources":["../../../src/link/create.js"],"names":[],"mappings":"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","file":"src/link/create.js","sourcesContent":["'use strict';\nmodule.exports = link;\n\nfunction link(scope) {\n  return new LinkBus(scope);\n}\n\nfunction LinkBus(scope) {\n  // the current linked scope\n  this.scope = scope;\n  // all source states\n  this.sources = [];\n  // all target states\n  this.targets = [];\n  // current transformer\n  this.transformer = function (nothing, x) {\n    return x;\n  };\n\n  this.scope.$on('$destroy', function () {\n    // kill all references bounded to this scope object\n    // in angular all listeners will be removed automatically\n    this.sources = null;\n    this.targets = null;\n    this.scope = null;\n    this.transformer = null;\n  }.bind(this));\n}\n\n// add a state as a change source\nLinkBus.prototype.source = function (state, field, deep) {\n  //1. state is always deep-watched\n  //2. state + field is not deepwatched by default\n  //3. state + arrayField is not deepwatched, but watchCollection is used + field is shallow watched\n  //4. state + arrayField + deep is deepwatched\n\n\n  var forceDeep = !field || deep;\n  var lengthyField = field && Array.isArray(state[field]);\n  var watchCollection = field && lengthyField && !forceDeep;\n  var watchReference = field && lengthyField;\n\n  // get hold of all registered states\n  this.sources.push({\n    state: state,\n    field: field\n  });\n\n  if (field && typeof state[field] === 'function') {\n    return this.fromFn(state, field);\n  }\n\n  var watched = function () {\n    return state[field];\n  };\n\n  if (!field) {\n    watched = function () {\n      return state;\n    };\n  }\n\n  var watchHandler = function (n, o) {\n    if (n !== o) {\n      console.log('value changed', {\n        forceDeep: forceDeep,\n        lengthy: lengthyField,\n        collection: watchCollection,\n        reference: watchReference,\n        n: n,\n        o: o\n      });\n\n      this._dispatch({\n        state: state,\n        field: field,\n        value: n});\n    }\n  }.bind(this);\n\n  var watcherFn = watchCollection ? this.scope.$watchCollection.bind(this.scope) : this.scope.$watch.bind(this.scope);\n  var deregisterEntityWatcher = watcherFn(watched, watchHandler, forceDeep);\n\n//  if (watchReference) {\n//    var referenceWatcher = function () {\n//      return state;\n//    };\n//\n//    this.scope.$watch(referenceWatcher, function (n, o) {\n//      if (n !== o) {\n//        console.log('reference watcher', n, o);\n//        // remove old watcher\n//        deregisterEntityWatcher();\n//\n//        // create a new watcher for fresh value\n//        deregisterEntityWatcher = watcherFn(function () {\n//          return n;\n//        }, watchHandler, forceDeep);\n//      }\n//    });\n//\n//  }\n\n  return this;\n};\n\n\n// dispatch change to all targets\nLinkBus.prototype._dispatch = function (newVal) {\n  if (!this.targets.length) {\n    console.log('The change event inside one of the links ' +\n      'has no targets!\\nSources: ' + this.sources);\n  }\n  this.targets.forEach(_applyTransformation(newVal, this.transformer));\n};\n\n\n// add a state as a change target\nLinkBus.prototype.target = function (state, field) {\n  if (!state) {\n    throw new Error('You specified an \"undefined\" state to link!');\n  }\n  this.targets.push({\n    state: state,\n    field: field\n  });\n  return this;\n};\n\n// add a transformer function to current link\n// should be of type (source, target) -> target\nLinkBus.prototype.map = function (fn) {\n  this.transformer = fn;\n  return this;\n};\n\n// link function call as a change source\nLinkBus.prototype.fromFn = function (state, fnName) {\n  // remember old function\n  var oldFn = state[fnName];\n\n  // hijack with decorator\n  state[fnName] = function () {\n    var args = [].slice.apply(arguments);\n\n    var result = oldFn.apply(state, args);\n\n    // dispatch change when this method is called\n    this._dispatch(result);\n  }.bind(this);\n\n  return this;\n};\n\n// propagate transformation to the given target\nfunction _applyTransformation(newVal, transformer) {\n  return function (target) {\n    var changedValue = target.field ? target.state[target.field] : target.state;\n    var newTargetValue = transformer(newVal.value, changedValue);\n\n    if (newTargetValue === undefined && !target.field) {\n      console.log('Warning! The link reset the target state to \"undefined\"!' +\n        '\\nFeels like a bug.' +\n        '\\nYou should use a pure function inside link.map().' +\n        '\\nThis function should return transformed state object:' +\n        '\\n' + transformer);\n    }\n\n    if (target.field) {\n      target.state[target.field] = newTargetValue;\n    } else {\n      // update all fields of the old target\n      // Pretending that it acts as an immutable\n      Object.keys(target.state).forEach(function (key) {\n        target.state[key] = newTargetValue[key];\n      });\n    }\n  };\n}"]}